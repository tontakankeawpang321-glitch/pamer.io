<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MediCheck - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Kanit -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f1f5f9;
            font-size: 16px;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Font ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏≠‡∏á‡∏ö‡∏ô iOS */
        input, select, textarea, button {
            font-size: 16px !important;
        }
        
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spin-slow {
            animation: spin 3s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px; width: 24px; /* ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏¥‡πâ‡∏ß */
            border-radius: 50%;
            background: #1e293b;
            cursor: pointer; margin-top: -10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px;
            cursor: pointer; background: #cbd5e1;
            border-radius: 3px;
        }
        input[type=range]:focus { outline: none; }

        /* Chatbot Styles */
        .chat-bubble-user {
            background-color: #1e293b;
            color: white;
            border-radius: 16px 16px 2px 16px;
            padding: 12px 16px;
            max-width: 85%;
            align-self: flex-end;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 0.95rem;
        }
        .chat-bubble-bot {
            background-color: white;
            color: #1e293b;
            border: 1px solid #e2e8f0;
            border-radius: 16px 16px 16px 2px;
            padding: 12px 16px;
            max-width: 85%;
            align-self: flex-start;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 0.95rem;
        }
        .typing-dot {
            width: 6px; height: 6px;
            background: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="text-slate-900 pb-32 min-h-screen relative">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-800 sticky top-0 z-30 shadow-md py-3 safe-area-top">
        <div class="max-w-xl mx-auto px-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 p-1.5 rounded-lg shadow-sm flex items-center justify-center">
                    <i data-lucide="activity" class="h-6 w-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white leading-none">MediCheck</h1>
                    <p class="text-xs text-slate-400 mt-0.5">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</p>
                </div>
            </div>
            <div class="text-[10px] text-slate-400 font-medium border border-slate-700 px-2 py-1 rounded bg-slate-800">
                AI Powered
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto px-4 mt-6">
        
        <!-- STEP 1: INPUT FORM -->
        <div id="step-input" class="fade-in-up">
            <div class="bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden">
                <div class="bg-slate-100 px-5 py-4 border-b border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 flex items-center">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-blue-800 mr-2"></i>
                        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
                    </h2>
                </div>
                
                <div class="p-5 space-y-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label class="text-sm font-bold text-slate-700 mb-2 block">‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)</label>
                            <input type="number" id="age" class="w-full h-12 px-4 rounded-xl border border-slate-300 bg-white focus:bg-white focus:border-blue-800 focus:ring-2 focus:ring-blue-100 outline-none transition-all placeholder-slate-400" placeholder="‡∏£‡∏∞‡∏ö‡∏∏">
                        </div>
                        <div class="col-span-1">
                            <label class="text-sm font-bold text-slate-700 mb-2 block">‡πÄ‡∏û‡∏®</label>
                            <div class="relative">
                                <select id="gender" class="w-full h-12 px-4 rounded-xl border border-slate-300 bg-white focus:border-blue-800 focus:ring-2 focus:ring-blue-100 outline-none appearance-none">
                                    <option value="not-specified">‡∏£‡∏∞‡∏ö‡∏∏...</option>
                                    <option value="male">‡∏ä‡∏≤‡∏¢</option>
                                    <option value="female">‡∏´‡∏ç‡∏¥‡∏á</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div class="col-span-2 sm:col-span-1">
                            <label class="text-sm font-bold text-slate-700 mb-2 block">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢</label>
                            <div class="relative">
                                <select id="temperature" class="w-full h-12 pl-10 pr-8 rounded-xl border border-slate-300 bg-white focus:border-blue-800 focus:ring-2 focus:ring-blue-100 outline-none appearance-none">
                                    <option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏ß‡∏£‡πâ‡∏≠‡∏ô)</option>
                                    <option value="warm">‡∏ï‡∏±‡∏ß‡∏£‡∏∏‡∏°‡πÜ (‡∏°‡∏µ‡πÑ‡∏Ç‡πâ‡∏ï‡πà‡∏≥)</option>
                                    <option value="hot">‡∏ï‡∏±‡∏ß‡∏£‡πâ‡∏≠‡∏ô‡∏à‡∏±‡∏î (‡πÑ‡∏Ç‡πâ‡∏™‡∏π‡∏á)</option>
                                </select>
                                <i data-lucide="thermometer" class="absolute left-3 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                                <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div class="col-span-2 sm:col-span-1">
                            <label class="text-sm font-bold text-slate-700 mb-2 block">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï</label>
                            <div class="relative">
                                <select id="pressure" class="w-full h-12 pl-10 pr-8 rounded-xl border border-slate-300 bg-white focus:border-blue-800 focus:ring-2 focus:ring-blue-100 outline-none appearance-none">
                                    <option value="unknown">‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö</option>
                                    <option value="normal">‡∏õ‡∏Å‡∏ï‡∏¥</option>
                                    <option value="low">‡∏ï‡πà‡∏≥ (‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏∑‡∏î‡∏ö‡πà‡∏≠‡∏¢)</option>
                                    <option value="high">‡∏™‡∏π‡∏á (‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß)</option>
                                </select>
                                <i data-lucide="activity" class="absolute left-3 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                                <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-5 h-5 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-bold text-slate-700 mb-2 block">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1)</label>
                        <div class="flex flex-wrap gap-2 mb-3" id="conditions-container"></div>
                        <input type="text" id="allergies" placeholder="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏û‡πâ‡∏¢‡∏≤ / ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡∏£‡∏∞‡∏ö‡∏∏‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="w-full h-12 px-4 rounded-xl border border-slate-300 bg-white focus:border-blue-800 focus:ring-2 focus:ring-blue-100 outline-none placeholder-slate-400">
                    </div>

                    <div class="border-t border-slate-200 my-2"></div>

                    <div>
                        <label class="text-sm font-bold text-slate-700 mb-2 block">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô *</label>
                        <textarea id="symptoms" rows="3" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á, ‡πÑ‡∏≠‡πÅ‡∏´‡πâ‡∏á‡πÜ, ‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢..." class="w-full p-4 rounded-xl border border-slate-300 bg-white focus:border-blue-800 focus:ring-2 focus:ring-blue-100 outline-none resize-none leading-relaxed"></textarea>

                        <div class="flex flex-col gap-5 mt-5">
                            <div>
                                <label class="text-sm font-bold text-slate-700 mb-2 block">‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏£</label>
                                <div class="flex shadow-sm rounded-xl overflow-hidden">
                                    <input type="number" id="duration" class="w-full h-12 px-4 border border-r-0 border-slate-300 bg-white focus:border-blue-800 focus:ring-1 focus:ring-blue-800 outline-none z-10 rounded-l-xl" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç">
                                    <select id="duration_unit" class="h-12 px-4 border border-l-0 border-slate-300 bg-slate-50 text-slate-700 outline-none rounded-r-xl font-medium min-w-[90px]">
                                        <option value="‡∏ß‡∏±‡∏ô">‡∏ß‡∏±‡∏ô</option>
                                        <option value="‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á">‡∏ä‡∏°.</option>
                                        <option value="‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå">wk</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <div class="flex justify-between items-end mb-3">
                                    <label class="text-sm font-bold text-slate-700 block">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏à‡πá‡∏ö‡∏õ‡∏ß‡∏î</label>
                                    <span id="pain-score-display" class="font-bold text-white text-base bg-blue-600 px-3 py-0.5 rounded-full shadow-sm">5 / 10</span>
                                </div>
                                <div class="h-12 flex items-center px-4 border border-slate-300 rounded-xl bg-slate-50">
                                    <input type="range" id="pain_score" min="0" max="10" step="1" value="5" class="w-full">
                                </div>
                                <div class="flex justify-between text-xs text-slate-400 mt-1 px-1">
                                    <span>‡πÑ‡∏°‡πà‡πÄ‡∏à‡πá‡∏ö</span>
                                    <span>‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>
                                    <span>‡πÄ‡∏à‡πá‡∏ö‡∏°‡∏≤‡∏Å</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="analyzeSymptoms()" class="w-full mt-2 bg-slate-900 hover:bg-slate-800 text-white font-bold text-lg py-4 rounded-xl shadow-lg shadow-slate-300 transition-all active:scale-[0.98] flex items-center justify-center space-x-3">
                        <span>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•</span>
                        <div class="bg-white/20 rounded-full p-1">
                            <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        </div>
                    </button>
                    
                    <p class="text-center text-xs text-slate-400 mt-2">
                        * ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏î‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏î‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå
                    </p>
                </div>
            </div>
        </div>

        <!-- STEP 2: LOADING -->
        <div id="step-loading" class="hidden h-[60vh] flex flex-col items-center justify-center text-center fade-in-up bg-white rounded-2xl border border-slate-200 shadow-sm mx-4">
            <div class="relative mb-8">
                <div class="w-20 h-20 border-[6px] border-slate-100 border-t-blue-800 rounded-full spin-slow"></div>
                <div class="absolute inset-0 m-auto flex items-center justify-center">
                    <i data-lucide="loader-2" class="w-8 h-8 text-blue-800 animate-pulse"></i>
                </div>
            </div>
            <h3 class="text-xl font-bold text-slate-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</h3>
            <p class="text-base text-slate-500 mt-2 px-6">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p>
        </div>

        <!-- STEP 3: RESULT -->
        <div id="step-result" class="hidden fade-in-up pb-10">
            <div id="result-container"></div>
            
            <div class="mt-6 bg-slate-900 text-white rounded-2xl p-6 shadow-xl relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-1/4 -translate-y-1/4">
                    <i data-lucide="hospital" class="w-48 h-48 text-white"></i>
                </div>
                
                <div class="relative z-10">
                    <div class="flex items-start justify-between mb-6">
                        <div>
                            <div class="text-xs text-slate-400 uppercase tracking-widest font-semibold mb-2">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</div>
                            <div class="text-sm opacity-90 mb-1">‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</div>
                            <div id="referral-dept" class="text-3xl font-bold text-blue-300 tracking-tight leading-tight">-</div>
                        </div>
                    </div>
                    
                    <button onclick="resetForm()" class="w-full bg-white text-slate-900 font-bold py-4 rounded-xl hover:bg-slate-100 transition-colors flex items-center justify-center space-x-2 shadow-lg active:scale-95">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                        <span>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Notification -->
        <div id="error-toast" class="hidden fixed bottom-24 left-4 right-4 bg-red-100 border-l-4 border-red-600 text-red-900 px-5 py-4 rounded-xl shadow-2xl z-50 text-sm font-medium flex items-center animate-bounce-in">
            <i data-lucide="alert-circle" class="w-6 h-6 mr-3 text-red-600 flex-shrink-0"></i>
            <span id="error-message" class="flex-1">Error</span>
            <button onclick="document.getElementById('error-toast').classList.add('hidden')" class="ml-4 p-2 bg-red-200 rounded-full text-red-700">‚úï</button>
        </div>

    </main>

    <!-- FLOATING CHATBOT BUTTON -->
    <button id="chatbot-floating-btn" onclick="toggleChat()" class="fixed bottom-6 right-6 sm:bottom-8 sm:right-8 bg-slate-900 hover:bg-slate-800 text-white w-14 h-14 rounded-full shadow-2xl transition-all z-40 hover:scale-110 active:scale-90 flex items-center justify-center border-2 border-white/20">
        <i data-lucide="message-circle" class="w-7 h-7"></i>
    </button>

    <!-- CHATBOT WINDOW (Mobile Optimized) -->
    <!-- Changed position from bottom-24 to bottom-4 for better mobile usage when button is hidden -->
    <div id="chatbot-window" class="fixed bottom-4 right-4 left-4 sm:left-auto sm:right-8 sm:w-[380px] h-[60vh] sm:h-[550px] bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col hidden z-50 animate-in fade-in slide-in-from-bottom-5 duration-300 overflow-hidden">
        <!-- Header -->
        <div class="bg-slate-900 p-4 flex justify-between items-center shadow-md">
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <div class="bg-blue-600 p-1.5 rounded-full">
                        <i data-lucide="bot" class="w-5 h-5 text-white"></i>
                    </div>
                    <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 rounded-full border-2 border-slate-900"></div>
                </div>
                <div>
                    <h3 class="text-white font-bold text-sm leading-tight">MediBot</h3>
                    <p class="text-[10px] text-slate-400">AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå</p>
                </div>
            </div>
            <button onclick="toggleChat()" class="text-slate-400 hover:text-white bg-white/10 p-1.5 rounded-full transition-colors">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        
        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-50 flex flex-col overscroll-contain">
            <!-- Intro Message -->
            <div class="chat-bubble-bot">
                ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö üëã ‡∏ú‡∏°‡∏Ñ‡∏∑‡∏≠ AI ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå <br>‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö?
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="p-3 border-t border-slate-200 bg-white">
            <div class="flex space-x-2 items-center">
                <input type="text" id="chat-input" class="flex-1 bg-slate-100 border-0 rounded-full px-4 py-3 text-base focus:ring-2 focus:ring-blue-500 outline-none placeholder-slate-400" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="bg-blue-600 hover:bg-blue-700 text-white w-11 h-11 rounded-full flex items-center justify-center flex-shrink-0 shadow-md active:scale-95 transition-transform">
                    <i data-lucide="send" class="w-5 h-5 ml-0.5"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- CHATBOT LOGIC ---
        function toggleChat() {
            const chatWindow = document.getElementById('chatbot-window');
            const floatingBtn = document.getElementById('chatbot-floating-btn');
            
            // Toggle Hidden Classes inversely
            const isChatHidden = chatWindow.classList.contains('hidden');
            
            if (isChatHidden) {
                // Open Chat
                chatWindow.classList.remove('hidden');
                floatingBtn.classList.add('hidden'); // Hide floating button
                
                // Delay focus slightly for mobile keyboard handling
                setTimeout(() => document.getElementById('chat-input').focus(), 100);
            } else {
                // Close Chat
                chatWindow.classList.add('hidden');
                floatingBtn.classList.remove('hidden'); // Show floating button
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            const messagesContainer = document.getElementById('chat-messages');

            if (!message) return;

            // 1. Show User Message
            appendChatMessage('user', message);
            input.value = '';

            // 2. Show Loading
            const loadingId = 'loading-' + Date.now();
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'chat-bubble-bot flex items-center space-x-1 w-16 justify-center';
            loadingBubble.id = loadingId;
            loadingBubble.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;
            messagesContainer.appendChild(loadingBubble);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // 3. Prepare Payload (MODE: CHAT)
            const fullPrompt = `‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á\n‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: ${message}`;

            try {
                const workerResponse = await fetch("https://pamer.tontakankeawpang321.workers.dev", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        mode: 'chat',
                        text: fullPrompt 
                    })
                });

                if (!workerResponse.ok) throw new Error("Connection failed");

                const data = await workerResponse.json();
                const rawResponse = data.reply;
                
                document.getElementById(loadingId).remove();

                let cleanText = rawResponse.replace(/```json\n?|\n?```/g, '').trim();
                try {
                     const parsed = JSON.parse(cleanText);
                     if (parsed.reply) cleanText = parsed.reply;
                     else if (parsed.clinicalSummary) cleanText = parsed.clinicalSummary;
                } catch(e) {}

                appendChatMessage('bot', cleanText);

            } catch (err) {
                console.error(err);
                document.getElementById(loadingId).remove();
                appendChatMessage('bot', '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß');
            }
        }

        function appendChatMessage(role, text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot';
            // Convert newlines to <br> for better formatting
            div.innerHTML = text.replace(/\n/g, '<br>');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- MAIN APP LOGIC ---
        let formData = {
            age: '',
            gender: 'not-specified',
            temperature: 'normal',
            pressure: 'unknown',
            underlying_conditions: [],
            allergies: '',
            symptoms: '',
            pain_score: 5,
            duration: '',
            duration_unit: '‡∏ß‡∏±‡∏ô'
        };

        const commonConditions = [
            "‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡∏™‡∏π‡∏á", "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô‡∏™‡∏π‡∏á", "‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à", "‡∏´‡∏≠‡∏ö‡∏´‡∏∑‡∏î", "‡πÇ‡∏£‡∏Ñ‡πÑ‡∏ï"
        ];

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            renderConditions();
            setupEventListeners();
        });

        function renderConditions() {
            const container = document.getElementById('conditions-container');
            container.innerHTML = commonConditions.map(cond => {
                const isSelected = formData.underlying_conditions.includes(cond);
                const baseClass = "text-sm py-2.5 px-4 rounded-xl border transition-all cursor-pointer select-none font-medium flex-grow text-center sm:flex-grow-0";
                const activeClass = "bg-slate-800 border-slate-800 text-white shadow-md transform scale-105"; 
                const inactiveClass = "bg-white border-slate-200 text-slate-600 hover:bg-slate-50";
                
                return `<button onclick="toggleCondition('${cond}')" class="${baseClass} ${isSelected ? activeClass : inactiveClass}">${cond}</button>`;
            }).join('');
        }

        function setupEventListeners() {
            const inputs = ['age', 'gender', 'temperature', 'pressure', 'allergies', 'symptoms', 'duration', 'duration_unit', 'pain_score'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', (e) => {
                        formData[id] = e.target.value;
                        if (id === 'pain_score') {
                            document.getElementById('pain-score-display').textContent = `${e.target.value} / 10`;
                        }
                    });
                }
            });
        }

        function toggleCondition(condition) {
            if (formData.underlying_conditions.includes(condition)) {
                formData.underlying_conditions = formData.underlying_conditions.filter(c => c !== condition);
            } else {
                formData.underlying_conditions.push(condition);
            }
            renderConditions();
        }

        function parseAIResponse(text) {
            let cleanText = text.replace(/```json\n?|\n?```/g, '').trim();
            try {
                return JSON.parse(cleanText);
            } catch (e) {
                const firstBrace = cleanText.indexOf('{');
                const lastBrace = cleanText.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) {
                    const jsonString = cleanText.substring(firstBrace, lastBrace + 1);
                    return JSON.parse(jsonString);
                }
                throw e;
            }
        }

        async function analyzeSymptoms() {
            if (!formData.symptoms || !formData.age) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏≠‡∏≤‡∏¢‡∏∏ ‡πÅ‡∏•‡∏∞ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô');
                return;
            }

            setStep('loading');

            const systemPrompt = `‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ AI ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (Medical Triage)
            ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤
            ‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö:
            1. ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            2. ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà "‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢" "‡∏™‡∏∏‡∏†‡∏≤‡∏û" ‡πÅ‡∏•‡∏∞ "‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á"
            3. ‡πÇ‡∏ó‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç ‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠
            
            ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á JSON ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:
            {
              "triageLevel": "‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô" | "‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô" | "‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô",
              "triageColor": "green" | "yellow" | "red",
              "clinicalSummary": "‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ",
              "differentialDiagnosis": ["‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ 1"],
              "immediateAction": "‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ",
              "lifestyleAdvice": ["‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á"],
              "medicationAdvice": ["‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏≤‡∏™‡∏≤‡∏°‡∏±‡∏ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ö‡πâ‡∏≤‡∏ô)"],
              "redFlags": ["‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢"],
              "doctorVisitCriteria": "‡∏Ñ‡∏ß‡∏£‡πÑ‡∏õ‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏£",
              "departmentReferral": "‡πÅ‡∏ú‡∏ô‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏õ‡∏û‡∏ö"
            }`;

            const tempMap = { 'normal': '‡∏õ‡∏Å‡∏ï‡∏¥', 'warm': '‡∏ï‡∏±‡∏ß‡∏£‡∏∏‡∏°‡πÜ (‡πÑ‡∏Ç‡πâ‡∏ï‡πà‡∏≥)', 'hot': '‡∏ï‡∏±‡∏ß‡∏£‡πâ‡∏≠‡∏ô‡∏à‡∏±‡∏î (‡πÑ‡∏Ç‡πâ‡∏™‡∏π‡∏á)' };
            const bpMap = { 'unknown': '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö', 'normal': '‡∏õ‡∏Å‡∏ï‡∏¥', 'low': '‡∏ï‡πà‡∏≥', 'high': '‡∏™‡∏π‡∏á' };

            const userQuery = `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:
            - ‡∏≠‡∏≤‡∏¢‡∏∏: ${formData.age}, ‡πÄ‡∏û‡∏®: ${formData.gender}
            - ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: ${tempMap[formData.temperature]}
            - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô: ${bpMap[formData.pressure]}
            - ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${formData.underlying_conditions.join(', ')}
            - ‡πÅ‡∏û‡πâ‡∏¢‡∏≤/‡∏≠‡∏≤‡∏´‡∏≤‡∏£: ${formData.allergies || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}
            - ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£: ${formData.symptoms}
            - ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏à‡πá‡∏ö (1-10): ${formData.pain_score}
            - ‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ô‡∏≤‡∏ô: ${formData.duration} ${formData.duration_unit}`;

            const fullPrompt = `${systemPrompt}\n\n${userQuery}`;

            try {
                // ‚úÖ SINGLE SOURCE OF TRUTH: Worker Only (MODE: TRIAGE)
                const workerResponse = await fetch("https://pamer.tontakankeawpang321.workers.dev", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        mode: 'triage',
                        text: fullPrompt 
                    })
                });

                if (!workerResponse.ok) {
                    throw new Error("Worker connection failed (" + workerResponse.status + ")");
                }

                const data = await workerResponse.json();
                const rawResponse = data.reply || (typeof data === 'string' ? data : '');
                
                if (!rawResponse) {
                     throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }

                const content = parseAIResponse(rawResponse);

                // Defaults
                content.differentialDiagnosis = content.differentialDiagnosis || [];
                content.lifestyleAdvice = content.lifestyleAdvice || [];
                content.medicationAdvice = content.medicationAdvice || [];
                content.redFlags = content.redFlags || [];
                content.clinicalSummary = content.clinicalSummary || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ";
                content.departmentReferral = content.departmentReferral || "-";
                content.immediateAction = content.immediateAction || "-";
                
                renderResult(content);
                setStep('result');

            } catch (err) {
                console.error(err);
                showError('‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (' + err.message + ')');
                setStep('input');
            }
        }

        function renderResult(result) {
            const container = document.getElementById('result-container');
            const dept = document.getElementById('referral-dept');

            let themeColor = "teal";
            let iconName = "check-circle";
            let statusText = "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô)";
            let badgeBg = "bg-teal-100 text-teal-800 border-teal-200";
            let borderColor = "border-teal-500";
            
            if (result.triageColor === 'red') {
                themeColor = "red";
                iconName = "alert-octagon";
                statusText = "‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô / ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢";
                badgeBg = "bg-red-100 text-red-800 border-red-200";
                borderColor = "border-red-500";
            } else if (result.triageColor === 'yellow') {
                themeColor = "amber";
                iconName = "alert-triangle";
                statusText = "‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå (‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô)";
                badgeBg = "bg-amber-100 text-amber-800 border-amber-200";
                borderColor = "border-amber-500";
            }

            const diagnosisTags = result.differentialDiagnosis.map(dx => 
                `<span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-lg text-sm font-medium border border-slate-200 shadow-sm">${dx}</span>`
            ).join('');

            const lifestyleList = result.lifestyleAdvice.map(item => 
                `<li class="flex items-start text-base text-slate-700 mb-3">
                    <div class="bg-slate-100 p-1 rounded-full mr-3 mt-0.5">
                        <i data-lucide="check" class="w-3.5 h-3.5 text-${themeColor}-600"></i>
                    </div>
                    <span>${item}</span>
                </li>`
            ).join('');

            const medItems = result.medicationAdvice && result.medicationAdvice.length > 0 
                ? result.medicationAdvice.map(item => 
                    `<li class="flex items-start text-base text-slate-700 mb-3">
                        <div class="bg-blue-100 p-1 rounded-full mr-3 mt-0.5">
                            <i data-lucide="pill" class="w-3.5 h-3.5 text-blue-600"></i>
                        </div>
                        <span>${item}</span>
                    </li>`
                ).join('') : '';

            const redFlags = result.redFlags && result.redFlags.length > 0
                ? result.redFlags.map(flag => 
                    `<li class="flex items-start text-base text-red-700 mb-3 font-medium">
                        <div class="bg-red-100 p-1 rounded-full mr-3 mt-0.5">
                            <i data-lucide="alert-circle" class="w-4 h-4 text-red-600"></i>
                        </div>
                        <span>${flag}</span>
                    </li>`
                ).join('') : '';

            container.innerHTML = `
                <div class="bg-white rounded-2xl shadow-lg border-l-8 ${borderColor} overflow-hidden mb-6">
                    <div class="p-6 border-b border-slate-100">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-xs font-bold uppercase tracking-wider text-slate-400">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á</span>
                            <span class="px-4 py-1.5 rounded-full text-xs font-bold border ${badgeBg}">${result.triageLevel || '‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß'}</span>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center">
                            <i data-lucide="${iconName}" class="w-8 h-8 text-${themeColor}-600 mr-3"></i>
                            ${statusText}
                        </h2>
                    </div>
                    <div class="p-6 bg-slate-50/50">
                        <h3 class="text-base font-bold text-slate-900 mb-3 flex items-center">
                            <i data-lucide="stethoscope" class="w-5 h-5 mr-2 text-slate-500"></i>
                            ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
                        </h3>
                        <p class="text-slate-700 leading-relaxed mb-5 text-base bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                            ${result.clinicalSummary}
                        </p>
                        <div>
                            <span class="text-xs font-bold text-slate-400 uppercase block mb-3">‡πÇ‡∏£‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢:</span>
                            <div class="flex flex-wrap gap-2">${diagnosisTags}</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-md border border-slate-200 overflow-hidden mb-6">
                    <div class="px-6 py-5 border-b border-slate-100 bg-slate-50 flex items-center">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-slate-600 mr-3"></i>
                        <h3 class="font-bold text-lg text-slate-800">‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h3>
                    </div>
                    
                    <div class="p-6 space-y-8">
                        <div>
                            <h4 class="text-base font-bold text-${themeColor}-700 mb-3 flex items-center">
                                <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                                ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                            </h4>
                            <div class="bg-${themeColor}-50 p-5 rounded-xl border border-${themeColor}-100 text-base text-${themeColor}-900 font-medium leading-relaxed shadow-sm">
                                ${result.immediateAction}
                            </div>
                        </div>

                        <div>
                            <h4 class="text-base font-bold text-slate-800 mb-3">‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</h4>
                            <ul class="list-none">${lifestyleList}</ul>
                        </div>

                        ${medItems ? `
                        <div>
                            <h4 class="text-base font-bold text-slate-800 mb-3">‡∏¢‡∏≤‡∏ö‡∏£‡∏£‡πÄ‡∏ó‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</h4>
                            <ul class="list-none bg-blue-50/50 p-5 rounded-xl border border-blue-100">${medItems}</ul>
                        </div>` : ''}
                    </div>
                </div>

                ${redFlags ? `
                <div class="bg-red-50 rounded-2xl shadow-md border border-red-200 overflow-hidden mb-6">
                    <div class="px-6 py-5 border-b border-red-100 flex items-center text-red-800 bg-red-100/50">
                        <i data-lucide="siren" class="w-6 h-6 mr-3"></i>
                        <h3 class="font-bold text-lg">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢ (Red Flags)</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-sm text-red-600 mb-4 font-semibold">‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡πÑ‡∏õ‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ:</p>
                        <ul class="list-none space-y-1">${redFlags}</ul>
                        ${result.doctorVisitCriteria ? `<div class="mt-6 pt-5 border-t border-red-200 text-sm font-semibold text-red-800 flex items-start bg-white/50 p-4 rounded-lg"><i data-lucide="clock" class="w-5 h-5 mr-2 flex-shrink-0 mt-0.5"></i> ${result.doctorVisitCriteria}</div>` : ''}
                    </div>
                </div>` : ''}
            `;
            
            dept.textContent = result.departmentReferral || "-";
            lucide.createIcons();
        }

        function setStep(stepName) {
            const steps = ['input', 'loading', 'result'];
            steps.forEach(s => {
                const el = document.getElementById(`step-${s}`);
                if (s === stepName) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            setStep('input');
            document.getElementById('result-container').innerHTML = '';
            document.getElementById('referral-dept').textContent = '-';
        }

        function showError(msg) {
            const toast = document.getElementById('error-toast');
            document.getElementById('error-message').textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
