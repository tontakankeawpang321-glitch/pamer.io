<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediCheck - ระบบคัดกรองเบื้องต้น</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Kanit -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f1f5f9;
            font-size: 16px;
            line-height: 1.6;
        }
        
        input, select, textarea, button {
            font-size: 16px !important;
        }
        
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .spin-slow {
            animation: spin 3s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: #1e293b;
            cursor: pointer; margin-top: -8px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer; background: #cbd5e1;
            border-radius: 2px;
        }
        input[type=range]:focus { outline: none; }

        /* Chatbot Styles */
        .chat-bubble-user {
            background-color: #1e293b; /* slate-800 */
            color: white;
            border-radius: 12px 12px 0 12px;
            padding: 10px 14px;
            max-width: 80%;
            align-self: flex-end;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chat-bubble-bot {
            background-color: white;
            color: #1e293b; /* slate-800 */
            border: 1px solid #e2e8f0;
            border-radius: 12px 12px 12px 0;
            padding: 10px 14px;
            max-width: 80%;
            align-self: flex-start;
            margin-bottom: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .typing-dot {
            width: 6px; height: 6px;
            background: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="text-slate-900 pb-10 min-h-screen relative">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-800 sticky top-0 z-20 shadow-md py-3">
        <div class="max-w-xl mx-auto px-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 p-1.5 rounded-lg shadow-sm flex items-center justify-center">
                    <i data-lucide="activity" class="h-5 w-5 text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white leading-none">MediCheck</h1>
                    <p class="text-xs text-slate-400 mt-0.5">ระบบคัดกรองสุขภาพเบื้องต้น</p>
                </div>
            </div>
            <div class="text-xs text-slate-400 font-medium border border-slate-700 px-2 py-1 rounded">
                AI Health
            </div>
        </div>
    </header>

    <main class="max-w-xl mx-auto px-4 mt-6">
        
        <!-- STEP 1: INPUT FORM -->
        <div id="step-input" class="fade-in-up">
            <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden">
                <div class="bg-slate-100 px-5 py-3 border-b border-slate-200">
                    <h2 class="text-base font-bold text-slate-800 flex items-center">
                        <i data-lucide="clipboard-list" class="w-5 h-5 text-blue-800 mr-2"></i>
                        แบบฟอร์มประเมินอาการ
                    </h2>
                </div>
                
                <div class="p-5 space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-bold text-slate-700 mb-1.5 block">อายุ (ปี)</label>
                            <input type="number" id="age" class="w-full h-11 px-3 rounded-lg border border-slate-300 bg-white focus:bg-white focus:border-blue-800 focus:ring-1 focus:ring-blue-800 outline-none transition-all placeholder-slate-400" placeholder="ระบุตัวเลข">
                        </div>
                        <div>
                            <label class="text-sm font-bold text-slate-700 mb-1.5 block">เพศ</label>
                            <select id="gender" class="w-full h-11 px-3 rounded-lg border border-slate-300 bg-white focus:border-blue-800 focus:ring-1 focus:ring-blue-800 outline-none">
                                <option value="not-specified">ไม่ระบุ</option>
                                <option value="male">ชาย</option>
                                <option value="female">หญิง</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm font-bold text-slate-700 mb-1.5 block">อุณหภูมิร่างกาย</label>
                            <div class="relative">
                                <select id="temperature" class="w-full h-11 pl-3 pr-8 rounded-lg border border-slate-300 bg-white focus:border-blue-800 focus:ring-1 focus:ring-blue-800 outline-none appearance-none">
                                    <option value="normal">ปกติ</option>
                                    <option value="warm">ตัวรุมๆ (มีไข้ต่ำ)</option>
                                    <option value="hot">ตัวร้อนจัด (ไข้สูง)</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-slate-500 pointer-events-none"></i>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-bold text-slate-700 mb-1.5 block">ความดันโลหิต</label>
                            <div class="relative">
                                <select id="pressure" class="w-full h-11 pl-3 pr-8 rounded-lg border border-slate-300 bg-white focus:border-blue-800 focus:ring-1 focus:ring-blue-800 outline-none appearance-none">
                                    <option value="unknown">ไม่ทราบ</option>
                                    <option value="normal">ปกติ</option>
                                    <option value="low">ต่ำ</option>
                                    <option value="high">สูง</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-slate-500 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-bold text-slate-700 mb-2 block">โรคประจำตัว (เลือกได้มากกว่า 1)</label>
                        <div class="flex flex-wrap gap-2 mb-3" id="conditions-container"></div>
                        <input type="text" id="allergies" placeholder="ประวัติแพ้ยา / แพ้อาหาร (ถ้ามี)" class="w-full h-11 px-3 rounded-lg border border-slate-300 bg-white focus:border-blue-800 focus:ring-1 focus:ring-blue-800 outline-none placeholder-slate-400">
                    </div>

                    <div class="border-t border-slate-200 my-2"></div>

                    <div>
                        <label class="text-sm font-bold text-slate-700 mb-2 block">เล่าอาการที่เป็น</label>
                        <textarea id="symptoms" rows="3" placeholder="เช่น ปวดท้องขวาล่างมาก, ไอแห้งๆ, อ่อนเพลีย ไม่มีแรง..." class="w-full p-3 rounded-lg border border-slate-300 bg-white focus:border-blue-800 focus:ring-1 focus:ring-blue-800 outline-none resize-none leading-relaxed"></textarea>

                        <div class="flex flex-col sm:flex-row gap-4 mt-4">
                            <div class="flex-1">
                                <label class="text-sm font-bold text-slate-700 mb-1.5 block">เป็นมานานเท่าไร</label>
                                <div class="flex">
                                    <input type="number" id="duration" class="w-full h-11 px-3 rounded-l-lg border border-r-0 border-slate-300 bg-white focus:border-blue-800 focus:ring-1 focus:ring-blue-800 outline-none z-10" placeholder="ระบุตัวเลข">
                                    <select id="duration_unit" class="h-11 px-2 rounded-r-lg border border-slate-300 bg-slate-100 text-slate-700 outline-none border-l-0">
                                        <option value="วัน">วัน</option>
                                        <option value="ชั่วโมง">ชั่วโมง</option>
                                        <option value="สัปดาห์">สัปดาห์</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="text-sm font-bold text-slate-700 mb-1.5 block flex justify-between items-center">
                                    <span>ระดับความเจ็บปวด (1-10)</span>
                                    <span id="pain-score-display" class="font-bold text-blue-800 text-lg bg-blue-100 px-2 rounded">5</span>
                                </label>
                                <div class="h-11 flex items-center px-2 border border-slate-300 rounded-lg bg-slate-50">
                                    <input type="range" id="pain_score" min="0" max="10" step="1" value="5" class="w-full">
                                </div>
                            </div>
                        </div>
                    </div>

                    <button onclick="analyzeSymptoms()" class="w-full mt-2 bg-slate-900 hover:bg-slate-800 text-white font-bold text-lg py-3.5 rounded-xl shadow-lg transition-all active:scale-[0.98] flex items-center justify-center space-x-2">
                        <span>เริ่มประเมินผล</span>
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                    
                    <p class="text-center text-xs text-slate-500 mt-2">
                        * ข้อมูลนี้ใช้เพื่อแนะนำเบื้องต้นเท่านั้น ไม่สามารถใช้แทนการวินิจฉัยของแพทย์ได้
                    </p>
                </div>
            </div>
        </div>

        <!-- STEP 2: LOADING -->
        <div id="step-loading" class="hidden h-[400px] flex flex-col items-center justify-center text-center fade-in-up bg-white rounded-xl border border-slate-200 shadow-sm">
            <div class="relative mb-6">
                <div class="w-16 h-16 border-[6px] border-slate-100 border-t-blue-800 rounded-full spin-slow"></div>
                <div class="absolute inset-0 m-auto flex items-center justify-center">
                    <i data-lucide="loader-2" class="w-6 h-6 text-blue-800 animate-pulse"></i>
                </div>
            </div>
            <h3 class="text-lg font-bold text-slate-800">กำลังประมวลผลข้อมูล...</h3>
            <p class="text-base text-slate-500 mt-2">ระบบ AI กำลังวิเคราะห์ความเสี่ยงและอาการของคุณ</p>
        </div>

        <!-- STEP 3: RESULT -->
        <div id="step-result" class="hidden fade-in-up">
            <div id="result-container"></div>
            
            <div class="mt-6 bg-slate-900 text-white rounded-xl p-6 shadow-xl relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-1/4 -translate-y-1/4">
                    <i data-lucide="hospital" class="w-48 h-48 text-white"></i>
                </div>
                
                <div class="relative z-10">
                    <div class="flex items-start justify-between mb-6">
                        <div>
                            <div class="text-xs text-slate-400 uppercase tracking-widest font-semibold mb-2">คำแนะนำการส่งต่อ</div>
                            <div class="text-sm opacity-90 mb-1">แผนกแพทย์ที่แนะนำ:</div>
                            <div id="referral-dept" class="text-3xl font-bold text-blue-300 tracking-tight">-</div>
                        </div>
                    </div>
                    
                    <button onclick="resetForm()" class="w-full bg-white text-slate-900 font-bold py-4 rounded-lg hover:bg-slate-100 transition-colors flex items-center justify-center space-x-2 shadow-lg">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                        <span>ประเมินอาการใหม่</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Notification -->
        <div id="error-toast" class="hidden fixed bottom-6 right-6 bg-red-100 border-l-4 border-red-600 text-red-900 px-5 py-4 rounded shadow-xl z-50 text-sm font-medium flex items-center">
            <i data-lucide="alert-circle" class="w-5 h-5 mr-3 text-red-600"></i>
            <span id="error-message">Error</span>
            <button onclick="document.getElementById('error-toast').classList.add('hidden')" class="ml-4 font-bold text-red-500 hover:text-red-800">✕</button>
        </div>

    </main>

    <!-- FLOATING CHATBOT BUTTON -->
    <button onclick="toggleChat()" class="fixed bottom-6 right-6 bg-slate-800 hover:bg-slate-700 text-white p-4 rounded-full shadow-xl transition-all z-50 hover:scale-105 active:scale-95 flex items-center justify-center">
        <i data-lucide="message-circle" class="w-7 h-7"></i>
    </button>

    <!-- CHATBOT WINDOW -->
    <div id="chatbot-window" class="fixed bottom-24 right-6 w-[340px] h-[450px] bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col hidden z-40 animate-in fade-in slide-in-from-bottom-10 duration-300">
        <!-- Header -->
        <div class="bg-slate-800 p-4 rounded-t-2xl flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                <h3 class="text-white font-bold">MediBot Assistant</h3>
            </div>
            <button onclick="toggleChat()" class="text-slate-400 hover:text-white">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <!-- Messages Area -->
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-50 flex flex-col">
            <!-- Intro Message -->
            <div class="chat-bubble-bot">
                สวัสดีครับ ผมคือ AI ผู้ช่วยแพทย์ มีอะไรให้ผมช่วยแนะนำเบื้องต้นไหมครับ? (เช่น ถามอาการ, การดูแลตัวเอง)
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="p-3 border-t border-slate-200 bg-white rounded-b-2xl">
            <div class="flex space-x-2">
                <input type="text" id="chat-input" class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-600" placeholder="พิมพ์ข้อความ..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition-colors">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // API Key injected automatically
        
        // --- CHATBOT LOGIC ---
        function toggleChat() {
            const chatWindow = document.getElementById('chatbot-window');
            chatWindow.classList.toggle('hidden');
            if (!chatWindow.classList.contains('hidden')) {
                document.getElementById('chat-input').focus();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            const messagesContainer = document.getElementById('chat-messages');

            if (!message) return;

            // 1. Show User Message
            appendChatMessage('user', message);
            input.value = '';

            // 2. Show Loading
            const loadingId = 'loading-' + Date.now();
            const loadingBubble = document.createElement('div');
            loadingBubble.className = 'chat-bubble-bot flex items-center space-x-1';
            loadingBubble.id = loadingId;
            loadingBubble.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;
            messagesContainer.appendChild(loadingBubble);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // 3. Prepare Payload
            // Using a simple prompt for chat context
            const fullPrompt = `บทบาท: ผู้ช่วยแพทย์ ให้คำปรึกษาเบื้องต้น สั้นกระชับ เข้าใจง่าย ตอบเป็นกันเอง\nคำถาม: ${message}`;

            try {
                // ✅ Fetch Logic requested by user
                const workerResponse = await fetch("https://pamer.tontakankeawpang321.workers.dev", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: fullPrompt }) // ✅ Worker รับ field นี้
                });

                if (!workerResponse.ok) throw new Error("Connection failed");

                const data = await workerResponse.json();
                
                // ✅ Receive Result logic requested by user
                const rawResponse = data.reply;
                
                // Removing Loading
                document.getElementById(loadingId).remove();

                // Clean response if it contains markdown JSON code blocks from other contexts
                let cleanText = rawResponse.replace(/```json\n?|\n?```/g, '').trim();
                
                // Try to see if it's JSON (sometimes worker forces JSON), if so, extract summary, otherwise show text
                try {
                    // Check if it looks like JSON
                    if (cleanText.startsWith('{') && cleanText.endsWith('}')) {
                        const parsed = JSON.parse(cleanText);
                        // If it's the full triage object, just show the summary
                        if (parsed.clinicalSummary) {
                            cleanText = parsed.clinicalSummary;
                        } else if (parsed.reply) {
                            cleanText = parsed.reply;
                        }
                    }
                } catch(e) {
                    // Not JSON, just plain text, which is good for chat
                }

                appendChatMessage('bot', cleanText);

            } catch (err) {
                console.error(err);
                document.getElementById(loadingId).remove();
                appendChatMessage('bot', 'ขออภัยครับ ระบบขัดข้องชั่วคราว');
            }
        }

        function appendChatMessage(role, text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = role === 'user' ? 'chat-bubble-user' : 'chat-bubble-bot';
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- MAIN APP LOGIC (EXISTING) ---
        let formData = {
            age: '',
            gender: 'not-specified',
            temperature: 'normal',
            pressure: 'unknown',
            underlying_conditions: [],
            allergies: '',
            symptoms: '',
            pain_score: 5,
            duration: '',
            duration_unit: 'วัน'
        };

        const commonConditions = [
            "เบาหวาน", "ความดันสูง", "ไขมันสูง", "โรคหัวใจ", "หอบหืด", "โรคไต"
        ];

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            renderConditions();
            setupEventListeners();
        });

        function renderConditions() {
            const container = document.getElementById('conditions-container');
            container.innerHTML = commonConditions.map(cond => {
                const isSelected = formData.underlying_conditions.includes(cond);
                const baseClass = "text-sm py-2 px-3 rounded-lg border transition-all cursor-pointer select-none font-medium";
                const activeClass = "bg-slate-700 border-slate-700 text-white shadow-sm"; 
                const inactiveClass = "bg-white border-slate-300 text-slate-600 hover:bg-slate-50";
                
                return `<button onclick="toggleCondition('${cond}')" class="${baseClass} ${isSelected ? activeClass : inactiveClass}">${cond}</button>`;
            }).join('');
        }

        function setupEventListeners() {
            const inputs = ['age', 'gender', 'temperature', 'pressure', 'allergies', 'symptoms', 'duration', 'duration_unit', 'pain_score'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', (e) => {
                        formData[id] = e.target.value;
                        if (id === 'pain_score') {
                            document.getElementById('pain-score-display').textContent = e.target.value;
                        }
                    });
                }
            });
        }

        function toggleCondition(condition) {
            if (formData.underlying_conditions.includes(condition)) {
                formData.underlying_conditions = formData.underlying_conditions.filter(c => c !== condition);
            } else {
                formData.underlying_conditions.push(condition);
            }
            renderConditions();
        }

        function parseAIResponse(text) {
            let cleanText = text.replace(/```json\n?|\n?```/g, '').trim();
            try {
                return JSON.parse(cleanText);
            } catch (e) {
                const firstBrace = cleanText.indexOf('{');
                const lastBrace = cleanText.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) {
                    const jsonString = cleanText.substring(firstBrace, lastBrace + 1);
                    return JSON.parse(jsonString);
                }
                throw e;
            }
        }

        async function analyzeSymptoms() {
            if (!formData.symptoms || !formData.age) {
                alert('กรุณากรอกข้อมูลสำคัญ: อายุ และ อาการที่เป็น');
                return;
            }

            setStep('loading');

            const systemPrompt = `บทบาท: คุณคือ AI ทางการแพทย์ที่ทำหน้าที่คัดกรองผู้ป่วยเบื้องต้น (Medical Triage)
            คำสั่ง: วิเคราะห์ข้อมูลผู้ป่วยที่ได้รับ และประเมินความเร่งด่วน รวมถึงให้คำแนะนำการรักษา
            ข้อกำหนดการตอบกลับ:
            1. ตอบเป็น JSON เท่านั้น
            2. ใช้ภาษาไทยที่ "เข้าใจง่าย" "สุภาพ" และ "จริงจัง"
            3. โทนเสียง: เป็นผู้เชี่ยวชาญ น่าเชื่อถือ
            
            โครงสร้าง JSON ที่ต้องการ:
            {
              "triageLevel": "ไม่เร่งด่วน" | "เร่งด่วน" | "ฉุกเฉิน",
              "triageColor": "green" | "yellow" | "red",
              "clinicalSummary": "สรุปอาการและสาเหตุที่เป็นไปได้",
              "differentialDiagnosis": ["โรคที่อาจเป็นไปได้ 1"],
              "immediateAction": "การรักษาเบื้องต้นที่ทำได้ทันที",
              "lifestyleAdvice": ["คำแนะนำการดูแลตัวเอง"],
              "medicationAdvice": ["ชื่อยาที่แนะนำ (เช่น ยาสามัญประจำบ้าน)"],
              "redFlags": ["สัญญาณอันตราย"],
              "doctorVisitCriteria": "ควรไปพบแพทย์เมื่อไร",
              "departmentReferral": "แผนกแพทย์ที่ควรไปพบ"
            }`;

            const tempMap = { 'normal': 'ปกติ', 'warm': 'ตัวรุมๆ (ไข้ต่ำ)', 'hot': 'ตัวร้อนจัด (ไข้สูง)' };
            const bpMap = { 'unknown': 'ไม่ทราบ', 'normal': 'ปกติ', 'low': 'ต่ำ', 'high': 'สูง' };

            const userQuery = `ข้อมูลผู้ป่วย:
            - อายุ: ${formData.age}, เพศ: ${formData.gender}
            - อุณหภูมิ: ${tempMap[formData.temperature]}
            - ความดัน: ${bpMap[formData.pressure]}
            - โรคประจำตัว: ${formData.underlying_conditions.join(', ')}
            - แพ้ยา/อาหาร: ${formData.allergies || 'ไม่มี'}
            - อาการ: ${formData.symptoms}
            - ระดับความเจ็บ (1-10): ${formData.pain_score}
            - เป็นมานาน: ${formData.duration} ${formData.duration_unit}`;

            const fullPrompt = `${systemPrompt}\n\n${userQuery}`;

            try {
                let content;
                
                // --- ATTEMPT 1: Worker ---
                try {
                    const workerResponse = await fetch("https://pamer.tontakankeawpang321.workers.dev", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: fullPrompt })
                    });

                    if (workerResponse.ok) {
                         const data = await workerResponse.json();
                         const rawResponse = data.reply || (typeof data === 'string' ? data : '');
                         if (rawResponse) {
                             content = parseAIResponse(rawResponse);
                         }
                    }
                } catch (e) {
                    console.warn("Worker connection failed, attempting fallback...", e);
                }

                // --- ATTEMPT 2: Fallback (Direct API) ---
                if (!content) {
                    console.log("Using Fallback API");
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: fullPrompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    
                    if (!response.ok) throw new Error('การเชื่อมต่อล้มเหลว (Connection Error)');
                    
                    const data = await response.json();
                    const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!rawText) throw new Error("API ไม่ส่งข้อมูลกลับมา");
                    content = parseAIResponse(rawText);
                }

                // Defaults
                content.differentialDiagnosis = content.differentialDiagnosis || [];
                content.lifestyleAdvice = content.lifestyleAdvice || [];
                content.medicationAdvice = content.medicationAdvice || [];
                content.redFlags = content.redFlags || [];
                content.clinicalSummary = content.clinicalSummary || "ไม่สามารถสรุปข้อมูลได้";
                content.departmentReferral = content.departmentReferral || "-";
                content.immediateAction = content.immediateAction || "-";
                
                renderResult(content);
                setStep('result');

            } catch (err) {
                console.error(err);
                showError('ระบบขัดข้องชั่วคราว กรุณาลองใหม่อีกครั้ง');
                setStep('input');
            }
        }

        function renderResult(result) {
            const container = document.getElementById('result-container');
            const dept = document.getElementById('referral-dept');

            let themeColor = "teal";
            let iconName = "check-circle";
            let statusText = "อาการทั่วไป (ไม่เร่งด่วน)";
            let badgeBg = "bg-teal-100 text-teal-800 border-teal-200";
            let borderColor = "border-teal-500";
            
            if (result.triageColor === 'red') {
                themeColor = "red";
                iconName = "alert-octagon";
                statusText = "ฉุกเฉิน / อันตราย";
                badgeBg = "bg-red-100 text-red-800 border-red-200";
                borderColor = "border-red-500";
            } else if (result.triageColor === 'yellow') {
                themeColor = "amber";
                iconName = "alert-triangle";
                statusText = "ควรพบแพทย์ (เร่งด่วน)";
                badgeBg = "bg-amber-100 text-amber-800 border-amber-200";
                borderColor = "border-amber-500";
            }

            const diagnosisTags = result.differentialDiagnosis.map(dx => 
                `<span class="px-3 py-1 bg-slate-50 text-slate-700 rounded-md text-sm font-medium border border-slate-200 shadow-sm">${dx}</span>`
            ).join('');

            const lifestyleList = result.lifestyleAdvice.map(item => 
                `<li class="flex items-start text-sm text-slate-700 mb-2">
                    <i data-lucide="check" class="w-4 h-4 text-${themeColor}-600 mr-2 mt-0.5 flex-shrink-0"></i>
                    <span>${item}</span>
                </li>`
            ).join('');

            const medItems = result.medicationAdvice && result.medicationAdvice.length > 0 
                ? result.medicationAdvice.map(item => 
                    `<li class="flex items-start text-sm text-slate-700 mb-2">
                        <i data-lucide="pill" class="w-4 h-4 text-blue-600 mr-2 mt-0.5 flex-shrink-0"></i>
                        <span>${item}</span>
                    </li>`
                ).join('') : '';

            const redFlags = result.redFlags && result.redFlags.length > 0
                ? result.redFlags.map(flag => 
                    `<li class="flex items-start text-sm text-red-700 mb-2">
                        <i data-lucide="alert-circle" class="w-4 h-4 text-red-600 mr-2 mt-0.5 flex-shrink-0"></i>
                        <span>${flag}</span>
                    </li>`
                ).join('') : '';

            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-md border-l-4 ${borderColor} overflow-hidden mb-6">
                    <div class="p-6 border-b border-slate-100">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs font-bold uppercase tracking-wider text-slate-400">ระดับความรุนแรง</span>
                            <span class="px-3 py-1 rounded-full text-xs font-bold border ${badgeBg}">${result.triageLevel || 'ประเมินแล้ว'}</span>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center">
                            <i data-lucide="${iconName}" class="w-8 h-8 text-${themeColor}-600 mr-3"></i>
                            ${statusText}
                        </h2>
                    </div>
                    <div class="p-6 bg-slate-50/50">
                        <h3 class="text-sm font-bold text-slate-900 mb-3 flex items-center">
                            <i data-lucide="stethoscope" class="w-4 h-4 mr-2 text-slate-500"></i>
                            สรุปผลการวิเคราะห์
                        </h3>
                        <p class="text-slate-700 leading-relaxed mb-4 text-sm bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                            ${result.clinicalSummary}
                        </p>
                        <div>
                            <span class="text-xs font-semibold text-slate-500 block mb-2">โรคที่เข้าข่าย:</span>
                            <div class="flex flex-wrap gap-2">${diagnosisTags}</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex items-center">
                        <i data-lucide="clipboard-list" class="w-5 h-5 text-slate-600 mr-2"></i>
                        <h3 class="font-bold text-slate-800">แผนการรักษาและคำแนะนำ</h3>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <div>
                            <h4 class="text-sm font-bold text-${themeColor}-700 mb-2 flex items-center">
                                <i data-lucide="zap" class="w-4 h-4 mr-2"></i>
                                สิ่งที่ควรทำทันที
                            </h4>
                            <div class="bg-${themeColor}-50 p-4 rounded-lg border border-${themeColor}-100 text-sm text-${themeColor}-900 font-medium leading-relaxed">
                                ${result.immediateAction}
                            </div>
                        </div>

                        <div>
                            <h4 class="text-sm font-bold text-slate-700 mb-2">การดูแลตนเอง</h4>
                            <ul class="list-none">${lifestyleList}</ul>
                        </div>

                        ${medItems ? `
                        <div>
                            <h4 class="text-sm font-bold text-slate-700 mb-2">ยาบรรเทาอาการ</h4>
                            <ul class="list-none bg-blue-50/50 p-4 rounded-lg border border-blue-100">${medItems}</ul>
                        </div>` : ''}
                    </div>
                </div>

                ${redFlags ? `
                <div class="bg-red-50 rounded-xl shadow-sm border border-red-200 overflow-hidden mb-6">
                    <div class="px-6 py-4 border-b border-red-100 flex items-center text-red-800">
                        <i data-lucide="siren" class="w-5 h-5 mr-2"></i>
                        <h3 class="font-bold">สัญญาณอันตราย (Red Flags)</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-xs text-red-600 mb-3 font-medium">หากมีอาการดังต่อไปนี้ โปรดไปพบแพทย์ทันที:</p>
                        <ul class="list-none space-y-1">${redFlags}</ul>
                        ${result.doctorVisitCriteria ? `<div class="mt-4 pt-4 border-t border-red-200 text-xs font-semibold text-red-800 flex items-center"><i data-lucide="clock" class="w-3 h-3 mr-1"></i> ${result.doctorVisitCriteria}</div>` : ''}
                    </div>
                </div>` : ''}
            `;
            
            dept.textContent = result.departmentReferral || "-";
            lucide.createIcons();
        }

        function setStep(stepName) {
            const steps = ['input', 'loading', 'result'];
            steps.forEach(s => {
                const el = document.getElementById(`step-${s}`);
                if (s === stepName) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            setStep('input');
            document.getElementById('result-container').innerHTML = '';
            document.getElementById('referral-dept').textContent = '-';
        }

        function showError(msg) {
            const toast = document.getElementById('error-toast');
            document.getElementById('error-message').textContent = msg;
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
